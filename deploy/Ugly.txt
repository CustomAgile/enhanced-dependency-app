<!DOCTYPE html>
<html>
<head>
    <title>enhanced-dependency-app-0.2.3</title>
    <!--  (c) 2017 CA Technologies.  All Rights Reserved. -->
    <!--  Build Date: Thu Oct 11 2018 23:16:34 GMT+0000 (UTC) -->

    <script type="text/javascript">
        var APP_BUILD_DATE = "Thu Oct 11 2018 23:16:34 GMT+0000 (UTC)";
        var CHECKSUM = 1205847909;
    </script>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>
    <!-- our highcharts (needed so that we can add patterns)
    <script type="text/javascript" src="/apps/2.1/lib/analytics/analytics-all.js"></script>
    -->


    <script type="text/javascript">
        Rally.onReady(function() {
            Ext.define("Utils.AncestorPiInlineFilter",{override:"Rally.ui.inlinefilter.QuickFilterPanel",portfolioItemTypes:[],modelName:void 0,customFilterNamePrefix:"AncestorPiInlineFilter.",_hasPiAncestor:function(a){return _.contains(["hierarchicalrequirement","userstory","defect"],a)||a.startsWith("portfolioitem")},_pisAbove:function(a){var b=[];if(_.contains(["hierarchicalrequirement","userstory","defect"],a))b=this.portfolioItemTypes;else if(a.startsWith("portfolioitem")){var c=_.findIndex(this.portfolioItemTypes,function(b){return b.get("TypePath").toLowerCase()===a});c>=0&&c<this.portfolioItemTypes.length-1&&(b=this.portfolioItemTypes.slice(c+1))}return b},initComponent:function(){this.modelName&&(this.modelName=this.modelName.toLowerCase());var a={},b=[];if(this._hasPiAncestor(this.modelName)){var c=this._pisAbove(this.modelName);_.each(c,function(d){var e=d.get("TypePath"),f=this.customFilterNamePrefix+e,g="Portfolio Item / "+d.get("Name");a[f]={xtype:"ancestorpisearchcombobox",portfolioItemType:e,piTypesAbove:c,artifactTypeName:this.modelName,storeConfig:{models:e,autoLoad:!0},allowNoEntry:!0,noEntryValue:null,noEntryText:"No "+g,emptyText:"Search "+g+"s...",allowClear:!1,valueField:"ObjectUUID"},b.push({name:f,displayName:g})},this),_.merge(this.addQuickFilterConfig,{additionalFields:b},function(a,b){return _.isArray(a)?a.concat(b):void 0}),Ext.override(Rally.ui.inlinefilter.FilterFieldFactory,a)}this.callParent(arguments)},_createFields:function(){this._hasPiAncestor(this.modelName)||(this.fields=_.filter(this.fields,function(a){return!Ext.String.startsWith(a,this.customFilterNamePrefix)},this),this.initialFilters=_.filter(this.initialFilters,function(a){return!Ext.String.startsWith(a.name,this.customFilterNamePrefix)},this)),this.callParent(arguments)}}),Ext.define("Utils.AncestorPiSearchComboBox",{alias:"widget.ancestorpisearchcombobox",extend:"Rally.ui.combobox.ArtifactSearchComboBox",parentField:"PortfolioItem.Parent.",artifactTypeName:void 0,piTypesAbove:[],initComponent:function(){this.storeConfig.filters=[{property:this.valueField,value:this.value}],this.storeConfig.filters=[],this.callParent(arguments)},getFilter:function(){var a=this.getRecord(),b=this.propertyPrefix(),c=[];return a?c.push({property:b+".ObjectUUID",value:a.get("ObjectUUID")}):c.push({property:b,value:null}),Rally.data.wsapi.Filter.or(c)},propertyPrefix:function(){var a;return"hierarchicalrequirement"===this.artifactTypeName||"userstory"===this.artifactTypeName?a=this.piTypesAbove[0].get("Name"):"defect"===this.artifactTypeName?a="Requirement."+this.piTypesAbove[0].get("Name"):this.artifactTypeName.startsWith("portfolioitem")&&(a="Parent"),a&&_.forEach(this.piTypesAbove,function(b){return b.get("TypePath").toLowerCase()==this.portfolioItemType.toLowerCase()?!1:void(a+=".Parent")},this),a}}),Ext.define("Rally.technicalservices.InfoLink",{extend:"Rally.ui.dialog.Dialog",alias:"widget.tsinfolink",informationHtml:null,title:"Build Information",defaults:{padding:5,margin:5},closable:!0,draggable:!0,autoShow:!0,width:350,informationalConfig:null,items:[{xtype:"container",itemId:"information"}],initComponent:function(){Ext.id(this);this.title="<span class='icon-help'> </span>"+this.title,this.callParent(arguments)},_generateChecksum:function(a){var b,c=305419896;for(a=a.replace(/var CHECKSUM = .*;/,""),a=a.replace(/var BUILDER  = .*;/,""),a=a.replace(/\s/g,""),b=0;b<a.length;b++)c+=a.charCodeAt(b)*b;return c},_checkChecksum:function(a){var b=Ext.create("Deft.Deferred"),c=this;return Ext.Ajax.request({url:document.URL,params:{id:1},success:function(a){if(text=a.responseText,CHECKSUM){var d=c._generateChecksum(text);if(CHECKSUM!==d)return void b.resolve(!1)}b.resolve(!0)}}),b.promise},_addToContainer:function(a){var b=Ext.apply({xtype:"container",height:200,overflowY:!0},this.informationalConfig);a.add(b)},afterRender:function(){var a=Rally.getApp();if(!Ext.isEmpty(this.informationalConfig)){var b=this.down("#information");this._addToContainer(b)}a.isExternal()?this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"... Running externally"}):this._checkChecksum(a).then({scope:this,success:function(a){a||this.addDocked({xtype:"container",cls:"build-info",dock:"bottom",padding:2,html:'<span class="icon-warning"> </span>Checksums do not match'})},failure:function(a){console.log("oops:",a)}}),this.callParent(arguments)},beforeRender:function(){if(this.callParent(arguments),this.informationHtml&&this.addDocked({xtype:"component",componentCls:"intro-panel",padding:2,html:this.informationHtml,doc:"top"}),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:"This app was created by the CA AC Technical Services Team."}),APP_BUILD_DATE){var a=Ext.String.format("Built on: {0} <br/>Built by: {1}",APP_BUILD_DATE,BUILDER);STORY&&(a=a+"<br/>Source story: "+STORY),this.addDocked({xtype:"container",cls:"build-info",padding:2,dock:"bottom",html:a})}}}),Ext.define("Rally.technicalservices.Logger",{constructor:function(a){Ext.apply(this,a)},log:function(a){var b="[ "+Ext.util.Format.date(new Date,"Y-m-d H:i:s.u")+" ]",c=[];c=Ext.Array.push(c,[b]),c=Ext.Array.push(c,Ext.Array.slice(arguments,0)),window.console&&console.log.apply(console,c)}}),Ext.define("CArABU.technicalservices.FieldPicker",{alias:"widget.fieldpickerbutton",extend:"Rally.ui.Button",requires:["Rally.ui.popover.Popover","Rally.ui.Button","Rally.ui.picker.FieldPicker","Ext.state.Manager"],toolTipConfig:{html:"Show Columns",anchor:"top"},iconCls:"icon-add-column",cls:"field-picker-btn secondary rly-small",alwaysSelectedValues:["FormattedID","Name"],fieldBlackList:["Milestones","Tags","Defects","Attachments"],fieldPickerConfig:{},buttonConfig:{},modelNames:["HierarchicalRequirement"],rankingEnabled:!1,margin:"3 9 0 0",constructor:function(a){this.config=_.merge({},this.config||{},a||{}),this.callParent([a])},initComponent:function(){if(this.models)return this.on("click",this._createPopover,this),void this.callParent(arguments);if(this.context&&this.modelNames&&this.modelNames.length>0)Rally.data.ModelFactory.getModels({types:this.modelNames,context:this.context,success:function(a){this.models=a,this.on("click",this._createPopover,this)},failure:function(a){this._setNoFieldPicker("There was an error retrieving models for the CArABU field picker.")},scope:this});else{var a="Please update the CA.technicalservices.FieldPicker configuration with modelNames and context";this._setNoFieldPicker(a)}this.callParent(arguments)},_setNoFieldPicker:function(a){this.iconCls="icon-none",this.toolTipConfig={html:'<div style="color:red;">'+a+"</div>"},this.on("click",function(){Rally.ui.notify.Notifier.showError({message:a})})},getFields:function(){return this._fields||this.alwaysSelectedValues},_getPickerConfig:function(){var a;return a=_.extend({value:this._fields,fieldBlackList:this.fieldBlackList,alwaysSelectedValues:this.alwaysSelectedValues,context:this.context},this.fieldPickerConfig)},_createPopover:function(a){var b=a.getEl();this.popover=Ext.create("Rally.ui.popover.Popover",{target:b,placement:["bottom","left","top","right"],cls:"field-picker-popover",toFront:Ext.emptyFn,buttonAlign:"center",title:this.getTitle(),listeners:{destroy:function(){this.popover=null},scope:this},buttons:[{xtype:"rallybutton",text:"Apply",cls:"field-picker-apply-btn primary rly-small",listeners:{click:function(){this._onApply(this.popover)},scope:this}},{xtype:"rallybutton",text:"Cancel",cls:"field-picker-cancel-btn secondary dark rly-small",listeners:{click:function(){this.popover.close()},scope:this}}],items:[_.extend({xtype:"rallyfieldpicker",cls:"field-picker",itemId:"fieldpicker",modelTypes:this._getModelTypes(),alwaysExpanded:!0,width:200,emptyText:"Search",selectedTextLabel:"Selected",availableTextLabel:"Available",listeners:{specialkey:function(a,b){b.getKey()===b.ESC&&this.popover.close()},scope:this}},this._getPickerConfig())]})},_getModelTypes:function(){return _.pluck(this._getModels(),"typePath")},getModel:function(){var a=this._getModels();return a.length>0?a[0]:null},getFieldObjects:function(){var a=this.getFields(),b=this._getModels();return b.length>0?Ext.Array.map(a,function(a){return b[0].getField(a)}):[]},_getModels:function(){return _.reduce(this.models,function(a,b){return"artifact"===b.typePath?a=a.concat(b.getArtifactComponentModels()):a.push(b),a},[])},getTitle:function(){return"Show Columns"},updateFields:function(a,b){this._fields=a,this.popover&&this.popover.down("rallyfieldpicker")&&this.popover.down("rallyfieldpicker").setValue(a.join(",")),this.saveState()},getState:function(){return{fields:this._fields}},applyState:function(a){a&&(this._fields=a.fields)},_onApply:function(a){var b=a.down("rallyfieldpicker"),c=_.map(b.getValue(),function(a){return a.get("name")});this.updateFields(c),a.close(),this.fireEvent("fieldsupdated",c)}}),Ext.define("CArABU.technicalservices.FileUtility",{singleton:!0,saveCSVToFile:function(a,b,c){void 0===c&&(c={type:"text/csv;charset=utf-8"}),this.saveAs(a,b,c)},saveAs:function(a,b){if(Ext.isIE9m)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for IE9 and below."});var c=null;try{c=new Blob([a],{type:"text/plain"})}catch(d){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,window.BlobBuilder&&"TypeError"==d.name&&(bb=new BlobBuilder,bb.append([a]),c=bb.getBlob("text/plain"))}if(!c)return void Rally.ui.notify.Notifier.showWarning({message:"Export is not supported for this browser."});var e=b;if(Ext.isIE10p)return void window.navigator.msSaveOrOpenBlob(c,e);var f=this.createObjectURL(c);if(f){var g=document.createElement("a");"download"in g?g.download=e:g.target="_blank",g.innerHTML="Download File",g.href=f,Ext.isChrome||(g.onclick=this.destroyClickedElement,g.style.display="none",document.body.appendChild(g)),g.click()}else Rally.ui.notify.Notifier.showError({message:"Export is not supported "})},createObjectURL:function(a){return window.webkitURL?window.webkitURL.createObjectURL(a):window.URL&&window.URL.createObjectURL?window.URL.createObjectURL(a):null},destroyClickedElement:function(a){document.body.removeChild(a.target)}}),Ext.define("CArABU.technicalservices.ModelBuilder",{singleton:!0,build:function(a,b){var c=Ext.create("Deft.Deferred");return Rally.data.ModelFactory.getModel({type:a,success:function(a){var d=[{name:"__predecessors"}],e=Ext.define(b,{extend:a,logger:new Rally.technicalservices.Logger,fields:d,loadPredecessors:function(a){var b=Ext.create("Deft.Deferred");return this.getCollection("Predecessors",{fetch:a,context:{project:null}}).load({callback:function(a,c){var d=Ext.Array.map(a,function(a){return a.getData()});this.set("__predecessors",d),b.resolve(this)},scope:this}),b.promise}});c.resolve(e)}}),c}}),Ext.define("enhanced-dependency-app",{extend:"Rally.app.App",componentCls:"app",logger:new Rally.technicalservices.Logger,piLevel0Name:"Feature",launch:function(){var a=Rally.data.util.PortfolioItemHelper.getPortfolioItemTypes();this.on("ready",function(){a.then({scope:this,success:function(a){this.portfolioItemTypes=a,this.piLevel0Name=a[0].get("Name"),this._addComponents(),(this._hasReleaseScope()||this._hasMilestoneScope())&&this._update()}})},this)},_addComponents:function(){this.removeAll();var a=this.add({xtype:"container",layout:"hbox"});this.add({xtype:"container",itemId:"filter_box",flex:1});this.add({xtype:"container",itemId:"display_box"}),this._getSelectorType()&&a.add({xtype:this._getSelectorType(),fieldLabel:"Release",labelAlign:"right",margin:"10 5 10 5",labelWidth:75,width:400,storeConfig:{context:{projectScopeDown:!1}},listeners:{scope:this,change:this._update}});var b=a.add({xtype:"fieldpickerbutton",modelNames:["HierarchicalRequirement"],context:this.getContext(),margin:"10 5 10 5",stateful:!0,stateId:"grid-columns",_fields:[this.piLevel0Name,"FormattedID","Name","ScheduleState","Iteration"]});b.on("fieldsupdated",this._update,this);var c=a.add({xtype:"rallyinlinefilterbutton",modelNames:["HierarchicalRequirement"],context:this.getContext(),margin:"10 5 10 5",stateful:!0,stateId:"grid-filters-3",listeners:{inlinefilterready:this._addInlineFilterPanel,scope:this},inlineFilterPanelConfig:{quickFilterPanelConfig:{portfolioItemTypes:this.portfolioItemTypes,modelName:"HierarchicalRequirement"}}});c.on("inlinefilterchange",this._update,this),a.add({xtype:"rallybutton",itemId:"btn-export",iconCls:"icon-export",cls:"rly-small secondary",margin:"10 5 10 5",align:"right",scope:this,handler:this._exportData})},_addInlineFilterPanel:function(a){this.down("#filter_box").add(a)},_getSelectorType:function(){return this._hasMilestoneScope()||this._hasReleaseScope()?null:"rallyreleasecombobox"},_getTimeBoxRecord:function(){return this.down("rallymilestonecombobox")&&this.down("rallymilestonecombobox").getRecord()?this.down("rallymilestonecombobox").getRecord():this.down("rallyreleasecombobox")&&this.down("rallyreleasecombobox").getRecord()?this.down("rallyreleasecombobox").getRecord():(this.logger.log("_getTimeboxRecord",this.getContext().getTimeboxScope()),this._hasMilestoneScope()||this._hasReleaseScope()?this.getContext().getTimeboxScope().getRecord()||null:null)},_hasTimeboxScope:function(a){return this.logger.log("_hasTimeboxScope",this.getContext().getTimeboxScope()),this.getContext().getTimeboxScope()&&this.getContext().getTimeboxScope().type.toLowerCase()===a.toLowerCase()?!0:!1},_hasMilestoneScope:function(){return this._hasTimeboxScope("milestone")},_hasReleaseScope:function(){return this._hasTimeboxScope("release")},onTimeboxScopeChange:function(a){!a||"milestone"!==a.getType().toLowerCase()&&"release"!==a.getType()||(this.callParent(arguments),this._update())},_exportData:function(){if(this.down("#grid-dependencies")){var a=this._getColumnCfgs(),b=[];Ext.Array.each(a,function(a){b.push(a.text)});var c=[b.join(",")],d=this.down("#grid-dependencies").getStore();d.each(function(b){var d=[];Ext.Array.each(a,function(a){var c=b.get(a.dataIndex);Ext.isObject(c)&&(c=c.FormattedID?Ext.String.format("{0}: {1}",c.FormattedID,c.Name):c.Name||c._refObjectName),d.push(c)}),c.push(d.join(","))});var e=Ext.String.format("dependencies-{0}.csv",Rally.util.DateTime.format(new Date,"Y-m-d-h-i-s"));CArABU.technicalservices.FileUtility.saveCSVToFile(c.join("\r\n"),e)}},_getTimeboxFilter:function(){var a=this._getTimeBoxRecord();this.logger.log("_getTimeBoxRecord",a);var b=null;if(a&&"milestone"===a.get("_type")&&(b=[{property:"Milestones",value:a.get("_ref")},{property:this.piLevel0Name+".Milestones",value:a.get("_ref")}],b=Rally.data.wsapi.Filter.or(b)),a&&"release"===a.get("_type")&&(b=[{property:"Release.Name",value:a.get("Name")},{property:this.piLevel0Name+".Release.Name",value:a.get("Name")}],b=Rally.data.wsapi.Filter.or(b)),b){b=b.and({property:"DirectChildrenCount",value:0});var c=this.down("rallyinlinefilterbutton");c&&c.inlineFilterPanel&&c.getWsapiFilter()&&(b=b.and(c.getWsapiFilter()))}return b},_update:function(){return this.down("#display_box").removeAll(),this._getTimeboxFilter()?void CArABU.technicalservices.ModelBuilder.build("HierarchicalRequirement","StoryPredecessor",this._getAdditionalPredecessorFields()).then({success:this._fetchData,failure:this._showErrorNotification,scope:this}):void this.down("#display_box").add({xtype:"container",html:'<div class="selector-msg"><span style="color:#888888;">Please select a valid Timebox.</span></div>'})},_getFetch:function(a){var b=this.down("fieldpickerbutton").getFields();return this.logger.log("_getFetch",b),b},_getAdditionalPredecessorFields:function(){var a=this.down("fieldpickerbutton").getFieldObjects(),b=["Predecessors","ObjectID"];this.logger.log("_getAdditionalPredecessorFields",a);var c=[];return Ext.Array.each(a,function(a){var d=null;if(!Ext.Array.contains(b,a.name)){"ScheduleState"===a.name&&(d=a.getAllowedValueStore());var e={name:"P"+a.name,displayName:"Predecessor "+a.displayName};d&&(e.getAllowedValueStore=function(){return d}),c.push(e)}}),this.logger.log("_getAdditionalPredecessorFields",c),c},_fetchData:function(a){var b=Ext.create("Rally.data.wsapi.Filter",{property:"Predecessors.ObjectID",operator:"!=",value:null}),c=this._getTimeboxFilter();b=b.and(c),this.logger.log("_fetchData filters",b,b.toString()),Ext.create("Rally.data.wsapi.Store",{model:a,fetch:this._getFetch(),filters:b,limit:"Infinity",context:{project:null}}).load({callback:this._loadPredecessors,scope:this})},_getColumnCfgs:function(){var a=this.down("fieldpickerbutton").getFieldObjects(),b=[];return Ext.Array.each(a,function(a){var c="__p"+a.name,d={dataIndex:c,text:"Predecessor "+a.displayName,tdCls:"tspredecessor"};"Name"===a.name&&(d.flex=1);var e=Rally.ui.renderer.RendererFactory.getRenderTemplate(a);d.renderer=function(a,b,c){return e.apply(c.get("__predecessor"))},d.sortable=!1,b.push(d)}),Ext.Array.each(a,function(a){var c={dataIndex:a.name,text:a.displayName};"Name"===a.name&&(c.flex=1);var d=Rally.ui.renderer.RendererFactory.getRenderTemplate(a);c.renderer=function(a,b,c){return d.apply(c.getData())},c.doSort=function(a){var b=this.up("rallygrid").getStore(),c=this.getSortParam();console.log("ds",b.sorters),b.sort({property:c,direction:a,sorterFn:function(a,b){return a=a.get(c),b=b.get(c),Ext.isObject(a)&&(a=a._refObjectName||a.Name||a.FormattedID||a),Ext.isObject(b)&&(b=b._refObjectName||b.Name||b.FormattedID||b),a?b?a>b?1:b>a?-1:0:1:-1}})},b.push(c)}),this.logger.log("_getColumnCfgs",b),b},_objectSort:function(a){},_loadPredecessors:function(a,b){this.logger.log("_loadPredecessors",a,b);var c=this._getFetch(),d=[],e=[];Ext.Array.each(a,function(a){Ext.Array.contains(e,a.get("ObjectID"))||(d.push(a.loadPredecessors(c)),e.push(a.get("ObjectID")))}),0===d.length?this._buildCustomGrid([]):Deft.Promise.all(d).then({success:this._buildCustomGrid,failure:this._showErrorNotification,scope:this})},_buildCustomGrid:function(a){this.logger.log("_buildCustomGrid",a);var b=[],c=this.down("fieldpickerbutton").getFields();Ext.Array.each(a,function(a){var d=a.get("__predecessors");Ext.Array.each(d,function(d){row=a.getData(),row.__predecessor=d,Ext.Array.each(c,function(a){row["__p"+a]=d[a]}),b.push(row)})});var d=c.concat(Ext.Array.map(c,function(a){return"__p"+a})).concat(["__predecessor"]);d.unshift("_ref");var e=Ext.create("Rally.data.custom.Store",{fields:d,data:b,pageSize:Math.max(b.length,200),remoteSort:!1});this.down("#grid-dependencies")&&this.down("#grid-dependencies").destroy(),this.down("#display_box").add({xtype:"rallygrid",itemId:"grid-dependencies",showRowActionsColumn:!1,showPagingToolbar:!1,store:e,columnCfgs:this._getColumnCfgs(),viewConfig:{stripeRows:!1},autoScroll:!0})},_showErrorNotification:function(a){this.logger.log("_showErrorNotification",a),Rally.ui.notify.Notifier.showError({message:a})},getOptions:function(){return[{text:"About...",handler:this._launchInfo,scope:this}]},_launchInfo:function(){this.about_dialog&&this.about_dialog.destroy(),this.about_dialog=Ext.create("Rally.technicalservices.InfoLink",{})},isExternal:function(){return"undefined"==typeof this.getAppId()}});

               Rally.launchApp('enhanced-dependency-app', {
                   name: 'enhanced-dependency-app'
               });
        });
    </script>

    <style type="text/css">

.app {
}
.tsinfolink {
    position:absolute;
    right:0px;
    width: 14px;
    height: 14px;
    border-radius: 7px;
    text-align: center;
    color: white;
    background: #C0C0C0;
    border-style: solid;
    border-width: 1px;
    margin-top: 25px;
    margin-right: 5px;
    cursor: pointer;
}

.tspredecessor{
    background-color: #EEEEEE;
}
.selector-msg {
    color: #222222;
    font-family: ProximaNovaSemiBold,Helvetica,Arial;
    font-size: 14px;
    margin-top: 0px;
    margin-left: 15px;
    display: inline-block;
}

    </style>

</head>
<body></body>
</html>